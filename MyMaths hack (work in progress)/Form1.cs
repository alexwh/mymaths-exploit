using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.Net;
using System.Text.RegularExpressions;
using System.Web;
using SHDocVw;

namespace MyMaths_hack
{
    public partial class Form1 : Form
    {
        int rand;
        bool gotAuthCode = false;
        bool gotTaskID = false;
        int authCode;
        int testID;
        int q1score;
        int q2score;

        string authstring;

        private SHDocVw.WebBrowser_V1 Web_V1;

        public Form1()
        {
            InitializeComponent();
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            Web_V1 = (SHDocVw.WebBrowser_V1)this.w.ActiveXInstance;
            Web_V1.NewWindow += new SHDocVw.DWebBrowserEvents_NewWindowEventHandler(Web_V1_NewWindow);
            Web_V1.NavigateComplete += new DWebBrowserEvents_NavigateCompleteEventHandler(Web_V1_NavigateComplete);
            Web_V1.Navigate("http://www.mymaths.co.uk", null, null, "User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:6.0.2) Gecko/20100101 Firefox/6.0.2");
            
        }

        void Web_V1_NavigateComplete(string URL)
        {
            string loc = URL;
            if (!gotAuthCode)
            {
                if (loc.Contains("http://www.mymaths.co.uk/indexLog.asp"))
                {
                    w.Navigate("http://www.mymaths.co.uk/auth.asp", null, null, "User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:6.0.2) Gecko/20100101 Firefox/6.0.2");
                }
                else if (loc.Contains("http://www.mymaths.co.uk/auth.asp"))
                {
                    //authstring = Web_V1.
                    string temp = authstring;
                    Properties.Settings.Default.authCode = Int32.Parse(HttpUtility.ParseQueryString(authstring).Get("authCode"));
                    gotAuthCode = true;
                    w.Navigate("http://www.mymaths.co.uk/indexLog.asp", null, null, "User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:6.0.2) Gecko/20100101 Firefox/6.0.2");

                }
            }
            else if (!gotTaskID)
            {
                if (loc.Contains("http://www.mymaths.co.uk/tasks/library/loadTask.asp"))
                {
                    Properties.Settings.Default.taskID = Int32.Parse(HttpUtility.ParseQueryString(loc).Get("taskID"));
                }
            }
        }

        private void button1_Click_1(object sender, EventArgs e)
        {
            var c = new Form2();
            c.Show();
        }

        private void timer1_Tick(object sender, EventArgs e)
        {
            label1.Text = "log in again";

        }
        private void Web_V1_NewWindow(string URL, int Flags, string TargetFrameName, ref object PostData, string Headers, ref bool Processed)
        {
            Processed = true; //Stop event from being processed

            //Code to open in same window
            this.w.Navigate(URL);

            //Code to open in new window instead of same window
            //Form1 Popup = new Form1();
            //Popup.webBrowser1.Navigate(URL);
            //Popup.Show();
        }

    }
}
