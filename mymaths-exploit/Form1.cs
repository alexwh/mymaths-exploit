using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.Net;
using System.Text.RegularExpressions;
using System.Web;

namespace mymaths_exploit
{
    public partial class Form1 : Form
    {
        bool gotAuthCode = false;
        bool gotTaskID = false;

        long sCode;
        int q1score;
        int q2score;
        int taskID;
        int authCode;


        string postData;
        byte[] postByte;

        string authstring;

        string UserAgent = "User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:15.0) Gecko/20100101 Firefox/15.0.1";

        Uri finalUrl;

        public Form1()
        {
            InitializeComponent();
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            w.DocumentText = Properties.Resources.intro.ToString();
        }

        void w_DocumentCompleted(object sender, WebBrowserDocumentCompletedEventArgs e)
        {
            string loc = e.Url.AbsoluteUri;
            if (loc == "http://www.mymaths.co.uk/" || loc == "http://www.mymaths.co.uk/index.asp")
            {
                w.Navigate("http://www.mymaths.co.uk/indexLog.asp?h=47955", null, postByte, "Content-Type: application/x-www-form-urlencoded");
            }
            if (!gotAuthCode)
            {
                if (loc.Contains("http://www.mymaths.co.uk/indexLog.asp"))
                {
                    w.Navigate("http://www.mymaths.co.uk/auth.asp", null, null, UserAgent);
                }
                else if (loc.Contains("http://www.mymaths.co.uk/auth.asp"))
                {
                    authstring = w.DocumentText;
                    Properties.Settings.Default.authCode = Int32.Parse(HttpUtility.ParseQueryString(authstring).Get("authCode"));
                    gotAuthCode = true;
                    w.Navigate("http://www.mymaths.co.uk", null, null, UserAgent);
                }
            }
            else if (!gotTaskID)
            {
                if (loc.Contains("http://www.mymaths.co.uk/tasks/library/loadTask.asp"))
                {
                    Properties.Settings.Default.taskID = Int32.Parse(HttpUtility.ParseQueryString(loc).Get("taskID"));
                    groupBox3.Enabled = true;
                }
            }
            if(w.DocumentText.Contains("&scoresaved=1"))
            {
                DialogResult result = MessageBox.Show("looks like it worked. do another task?", "mymaths-exploit", MessageBoxButtons.YesNo, MessageBoxIcon.Information);
                switch (result)
                {
                    case DialogResult.Yes: 
                        w.Navigate("http://www.mymaths.co.uk/indexLog.asp"); 
                        break;
                    default:
                        Application.Exit();
                        break;
                }
            }
            Properties.Settings.Default.Save();
        }

        private void w_NewWindow(object sender, CancelEventArgs e)
        {
            MessageBox.Show("a new window is going to open up in Internet Explorer with the task you have just selected", "mymaths-exploit", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            MessageBox.Show("please copy and paste the address of the url into the task box click load task", "mymaths-exploit", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            groupBox1.Enabled = true;
        }

        private void button2_Click(object sender, EventArgs e)
        {
            w.Navigate(textBox1.Text, null, null, UserAgent);
        }
        public void gensCode(int q1, int q2)
        {
            authCode = Properties.Settings.Default.authCode;
            taskID = Properties.Settings.Default.taskID;
            q1score = q1;
            q2score = q2;
            sCode = authCode * taskID;
            sCode = (sCode + (q1score * 100)) + q2score;
            sCode = sCode * 10000;
            sCode = sCode + (taskID * taskID);

            finalUrl = new Uri(String.Format("http://www.mymaths.co.uk/studentRecords/saveDataOH.asp?sCode={0}&q1score={1}&q2score={2}&taskID={3}", sCode, q1score, q2score, taskID));
            w.Navigate(finalUrl, null, null, UserAgent);
        }

        private void button1_Click(object sender, EventArgs e)
        {
            gensCode(Convert.ToInt32(q1.Value), Convert.ToInt32(q2.Value));
        }

        private void button3_Click(object sender, EventArgs e)
        {
            captureLogin(user.Text, pass.Text);
        }

        private void captureLogin(string username, string password)
        {
            System.Text.Encoding a = System.Text.Encoding.UTF8;
            postData = String.Format("xlog={0}&xpas={1}&timestamp=306&returns=&Submit=GO&flashPlayer=11", username, password);
            postByte = a.GetBytes(postData);
            w.Navigate("http://www.mymaths.co.uk/indexLog.asp?h=47955", null, postByte, "Content-Type: application/x-www-form-urlencoded");
        }

        private void pass_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                e.Handled = true;
                button3.PerformClick();
            }
        }

        private void button4_Click(object sender, EventArgs e)
        {
            var c = new Form2();
            c.Show();
        }
    }
}
